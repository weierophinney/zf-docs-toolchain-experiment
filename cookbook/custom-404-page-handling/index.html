<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">  
    <link rel="shortcut icon" href="../../img/favicon.ico">

    <title>Setting custom 404 page handling - Expressive</title>

    <link href="../../css/bootstrap-custom.min.css" rel="stylesheet">
    <link href="//maxcdn.bootstrapcdn.com/font-awesome/4.4.0/css/font-awesome.min.css" rel="stylesheet">
    <link rel="stylesheet" href="//cdn.jsdelivr.net/font-hack/2.018/css/hack.min.css">
    <link href="//fonts.googleapis.com/css?family=PT+Sans:400,400italic,700,700italic&subset=latin-ext,latin" rel="stylesheet" type="text/css">
    <link href="//fonts.googleapis.com/css?family=Open+Sans:300italic,400italic,700italic,400,300,600,700&subset=latin-ext,latin" rel="stylesheet" type="text/css">
    <link href="//fonts.googleapis.com/css?family=Libre+Baskerville:400,400italic,700&subset=latin,latin-ext" rel="stylesheet" type="text/css">
    <link href="../../css/base.css" rel="stylesheet">
    <link href="../../css/cinder.css" rel="stylesheet">
    <link href="../../css/prism-zf.css" rel="stylesheet">

    <!-- HTML5 shim and Respond.js IE8 support of HTML5 elements and media queries -->
    <!--[if lt IE 9]>
            <script src="https://oss.maxcdn.com/libs/html5shiv/3.7.0/html5shiv.js"></script>
            <script src="https://oss.maxcdn.com/libs/respond.js/1.3.0/respond.min.js"></script>
        <![endif]-->

    <script src="https://ajax.googleapis.com/ajax/libs/webfont/1.5.18/webfont.js"></script>
    <script>
    WebFont.load({
        google: {
            families: ['Open Sans', 'PT Sans']
        }
    });
    </script>

    
</head>

<body>

    <div class="navbar navbar-default navbar-fixed-top" role="navigation">
    <div class="container">

        <!-- Collapsed navigation -->
        <div class="navbar-header">
            
            <!-- Expander button -->
            <button type="button" class="navbar-toggle" data-toggle="collapse" data-target=".navbar-collapse">
                <span class="sr-only">Toggle navigation</span>
                <span class="icon-bar"></span>
                <span class="icon-bar"></span>
                <span class="icon-bar"></span>
            </button>
            

            <!-- Main title -->
            <span class="navbar-brand">
              <a href="http://framework.zend.com"><img src="../../img/zf-logo-mark.png" height="28" alt="Zend Framework" /></a>
              <a href="../..">Expressive</a>
            </span>
        </div>

        <!-- Expanded navigation -->
        <div class="navbar-collapse collapse">
            
                <!-- Main navigation -->
                <ul class="nav navbar-nav">
                
                
                    <li >
                        <a href="../..">Home</a>
                    </li>
                
                
                
                    <li class="dropdown">
                        <a href="#" class="dropdown-toggle" data-toggle="dropdown">Getting Started <b class="caret"></b></a>
                        <ul class="dropdown-menu">
                        
                            
<li >
    <a href="../../getting-started/features/">Overview and Features</a>
</li>

                        
                            
<li >
    <a href="../../getting-started/standalone/">Quick Start: Standalone</a>
</li>

                        
                            
<li >
    <a href="../../getting-started/skeleton/">Quick Start: Skeleton Installer</a>
</li>

                        
                        </ul>
                    </li>
                
                
                
                    <li class="dropdown">
                        <a href="#" class="dropdown-toggle" data-toggle="dropdown">Features <b class="caret"></b></a>
                        <ul class="dropdown-menu">
                        
                            
<li >
    <a href="../../features/application/">Applications</a>
</li>

                        
                            
  <li class="dropdown-submenu">
    <a tabindex="-1" href="">Containers</a>
    <ul class="dropdown-menu">
        
            
<li >
    <a href="../../features/container/intro/">Introduction</a>
</li>

        
            
<li >
    <a href="../../features/container/factories/">Container Factories</a>
</li>

        
            
<li >
    <a href="../../features/container/zend-servicemanager/">Using zend-servicemanager</a>
</li>

        
            
<li >
    <a href="../../features/container/pimple/">Using Pimple</a>
</li>

        
            
<li >
    <a href="../../features/container/aura-di/">Using Aura.Di</a>
</li>

        
    </ul>
  </li>

                        
                            
  <li class="dropdown-submenu">
    <a tabindex="-1" href="">Routing Adapters</a>
    <ul class="dropdown-menu">
        
            
<li >
    <a href="../../features/router/intro/">Introduction</a>
</li>

        
            
<li >
    <a href="../../features/router/interface/">Routing Interface</a>
</li>

        
            
<li >
    <a href="../../features/router/uri-generation/">URI Generation</a>
</li>

        
            
<li >
    <a href="../../features/router/result-observers/">Route Result Observers</a>
</li>

        
            
<li >
    <a href="../../features/router/piping/">Routing vs Piping</a>
</li>

        
            
<li >
    <a href="../../features/router/aura/">Using Aura</a>
</li>

        
            
<li >
    <a href="../../features/router/fast-route/">Using FastRoute</a>
</li>

        
            
<li >
    <a href="../../features/router/zf2/">Using the ZF2 Router</a>
</li>

        
    </ul>
  </li>

                        
                            
  <li class="dropdown-submenu">
    <a tabindex="-1" href="">Templating</a>
    <ul class="dropdown-menu">
        
            
<li >
    <a href="../../features/template/intro/">Introduction</a>
</li>

        
            
<li >
    <a href="../../features/template/interface/">Template Renderer Interface</a>
</li>

        
            
<li >
    <a href="../../features/template/middleware/">Templated Middleware</a>
</li>

        
            
<li >
    <a href="../../features/template/plates/">Using Plates</a>
</li>

        
            
<li >
    <a href="../../features/template/twig/">Using Twig</a>
</li>

        
            
<li >
    <a href="../../features/template/zend-view/">Using zend-view</a>
</li>

        
    </ul>
  </li>

                        
                            
<li >
    <a href="../../features/error-handling/">Error Handling</a>
</li>

                        
                            
  <li class="dropdown-submenu">
    <a tabindex="-1" href="">Helpers</a>
    <ul class="dropdown-menu">
        
            
<li >
    <a href="../../features/helpers/intro/">Introduction</a>
</li>

        
            
<li >
    <a href="../../features/helpers/url-helper/">UrlHelper</a>
</li>

        
            
<li >
    <a href="../../features/helpers/server-url-helper/">ServerUrlHelper</a>
</li>

        
            
<li >
    <a href="../../features/helpers/body-parse/">Body Parsing Middleware</a>
</li>

        
    </ul>
  </li>

                        
                            
<li >
    <a href="../../features/emitters/">Emitters</a>
</li>

                        
                        </ul>
                    </li>
                
                
                
                    <li class="dropdown active">
                        <a href="#" class="dropdown-toggle" data-toggle="dropdown">Cookbook <b class="caret"></b></a>
                        <ul class="dropdown-menu">
                        
                            
<li >
    <a href="../common-prefix-for-routes/">Prepending a common path to all routes</a>
</li>

                        
                            
<li >
    <a href="../route-specific-pipeline/">Route-specific middleware pipelines</a>
</li>

                        
                            
<li class="active">
    <a href="./">Setting custom 404 page handling</a>
</li>

                        
                            
<li >
    <a href="../using-custom-view-helpers/">Registering custom view helpers when using zend-view</a>
</li>

                        
                            
<li >
    <a href="../using-zend-form-view-helpers/">Using zend-form view helpers</a>
</li>

                        
                            
<li >
    <a href="../using-a-base-path/">Using Expressive from a subdirectory</a>
</li>

                        
                            
<li >
    <a href="../modular-layout/">Building modular applications</a>
</li>

                        
                            
<li >
    <a href="../setting-locale-depending-routing-parameter/">Setting a locale based on a routing parameter</a>
</li>

                        
                            
<li >
    <a href="../setting-locale-without-routing-parameter/">Setting a locale without a routing parameter</a>
</li>

                        
                            
<li >
    <a href="../debug-toolbars/">Enabling debug toolbars</a>
</li>

                        
                            
<li >
    <a href="../using-routed-middleware-class-as-controller/">Handling multiple routes in a single class</a>
</li>

                        
                        </ul>
                    </li>
                
                
                
                    <li class="dropdown">
                        <a href="#" class="dropdown-toggle" data-toggle="dropdown">Reference <b class="caret"></b></a>
                        <ul class="dropdown-menu">
                        
                            
<li >
    <a href="../../reference/usage-examples/">Examples</a>
</li>

                        
                            
<li >
    <a href="../../reference/expressive-projects/">Expressive Projects</a>
</li>

                        
                            
  <li class="dropdown-submenu">
    <a tabindex="-1" href="">Migration</a>
    <ul class="dropdown-menu">
        
            
<li >
    <a href="../../reference/migration/rc-to-v1/">From RC5 and Earlier</a>
</li>

        
    </ul>
  </li>

                        
                        </ul>
                    </li>
                
                
                </ul>
            

            <ul class="nav navbar-nav navbar-right">
                <li>
                    <a href="#" data-toggle="modal" data-target="#mkdocs_search_modal">
                        <i class="fa fa-search"></i> Search
                    </a>
                </li>
                
                    <li >
                        <a rel="prev" href="../route-specific-pipeline/">
                            <i class="fa fa-arrow-left"></i> Previous
                        </a>
                    </li>
                    <li >
                        <a rel="next" href="../using-custom-view-helpers/">
                            Next <i class="fa fa-arrow-right"></i>
                        </a>
                    </li>
                
                
                    <li>
                        <a href="https://github.com/zendframework/zend-expressive">
                            
                                <i class="fa fa-github"></i>
                            
                            GitHub
                        </a>
                    </li>
                
            </ul>
        </div>
    </div>
</div>

    <!-- content:begin -->
    <div class="container">
        
        <div class="col-md-3"><div class="bs-sidebar hidden-print affix well" role="complementary">
    <ul class="nav bs-sidenav">
    
        <li class="main active"><a href="#how-can-i-set-custom-404-page-handling">How can I set custom 404 page handling?</a></li>
        
            <li><a href="#calling-next-with-an-error-condition">Calling next with an error condition</a></li>
        
            <li><a href="#404-middleware">404 Middleware</a></li>
        
            <li><a href="#registering-custom-404-handlers">Registering custom 404 handlers</a></li>
        
    
    </ul>
</div></div>
        <div class="col-md-9" role="main">

<ol class="breadcrumb" role="navigation" aria-label="breadcrumbs navigation">
  <li><a href="../..">Docs</a> &raquo;</li>
  
    
      
        <li>Cookbook &raquo;</li>
      
    
  
  <li class="active">Setting custom 404 page handling</li>
</ol>

<nav class="hidden-lg">
  <ul class="pager">
    <li class="previous">
      <a rel="prev" href="../route-specific-pipeline/"><i class="fa fa-arrow-left"></i> Previous</a>
    </li>
    <li class="next">
      <a rel="next" href="../using-custom-view-helpers/">Next <i class="fa fa-arrow-right"></i></a>
    </li>
  </ul>
</nav>

<h1 id="how-can-i-set-custom-404-page-handling">How can I set custom 404 page handling?</h1>
<p>In some cases, you may want to handle 404 errors separately from the
<a href="../../features/error-handling/">final handler</a>. This can be done by registering
middleware that operates late &mdash; specifically, after the routing
middleware. Such middleware will be executed if no other middleware has
executed, and/or when all other middleware calls <code>return $next()</code>
without returning a response. Such situations typically mean that no middleware
was able to complete the request.</p>
<p>Your 404 handler can take one of two approaches:</p>
<ul>
<li>It can set the response status and call <code>$next()</code> with an error condition. In
  such a case, the final handler <em>will</em> likely be executed, but will have an
  explicit 404 status to work with.</li>
<li>It can create and return a 404 response itself.</li>
</ul>
<h2 id="calling-next-with-an-error-condition">Calling next with an error condition</h2>
<p>In the first approach, the <code>NotFound</code> middleware can be as simple as this:</p>
<pre class="codehilite"><code class="language-php">namespace Application;

class NotFound
{
    public function __invoke($req, $res, $next)
    {
        // Other things can be done here; e.g., logging
        return $next($req, $res-&gt;withStatus(404), 'Page Not Found');
    }
}</code></pre>


<p>This example uses the third, optional argument to <code>$next()</code>, which is an error
condition. Internally, the final handler will typically see this, and return an
error page of some sort. Since we set the response status, and it's an error
status code, that status code will be used in the generated response.</p>
<p>The <code>TemplatedErrorHandler</code> will use the error template in this particular case,
so you will likely need to make some accommodations for 404 responses in that
template if you choose this approach.</p>
<h2 id="404-middleware">404 Middleware</h2>
<p>In the second approach, the <code>NotFound</code> middleware will return a full response.
In our example here, we will render a specific template, and use this to seed
and return a response.</p>
<pre class="codehilite"><code class="language-php">namespace Application;

use Zend\Expressive\Template\TemplateRendererInterface;

class NotFound
{
    private $renderer;

    public function __construct(TemplateRendererInterface $renderer)
    {
        $this-&gt;renderer = $renderer;
    }

    public function __invoke($req, $res, $next)
    {
        // other things can be done here; e.g., logging
        // Now set the response status and write to the body
        $response = $res-&gt;withStatus(404);
        $response-&gt;getBody()-&gt;write($this-&gt;renderer-&gt;render('error::not-found'));
        return $response;
    }
}</code></pre>


<p>This approach allows you to have an application-specific workflow for 404 errors
that does not rely on the final handler.</p>
<h2 id="registering-custom-404-handlers">Registering custom 404 handlers</h2>
<p>We can register either <code>Application\NotFound</code> class above as service in the
<a href="../../features/container/intro/">service container</a>. In the case of the second approach,
you would also need to provide a factory for creating the middleware (to ensure
you inject the template renderer).</p>
<p>From there, you still need to register the middleware. This middleware is not
routed, and thus needs to be piped to the application instance. You can do this
via either configuration, or manually.</p>
<p>To do this via configuration, add an entry under the <code>middleware_pipeline</code>
configuration, after the dispatch middleware:</p>
<pre class="codehilite"><code class="language-php">'middleware_pipeline' =&gt; [
    /* ... */
    'routing' =&gt; [
        'middleware' =&gt; [
            Zend\Expressive\Container\ApplicationFactory::ROUTING_MIDDLEWARE,
            Zend\Expressive\Helper\UrlHelperMiddleware::class,
            Zend\Expressive\Container\ApplicationFactory::DISPATCH_MIDDLEWARE,
        ],
        'priority' =&gt; 1,
    ],
    [
        'middleware' =&gt; 'Application\NotFound',
        'priority' =&gt; -1,
    ],
    /* ... */
],</code></pre>


<p>The above example assumes you are using the <code>ApplicationFactory</code> and/or the
Expressive skeleton to manage your application instantiation and configuration.</p>
<p>To manually add the middleware, you will need to pipe it to the application
instance:</p>
<pre class="codehilite"><code class="language-php">$app-&gt;pipe($container-&gt;get('Application\NotFound'));</code></pre>


<p>This must be done <em>after</em>:</p>
<ul>
<li>calling <code>$app-&gt;pipeDispatchMiddleware()</code>, <strong>OR</strong></li>
<li>pulling the <code>Application</code> instance from the service container (assuming you
  used the <code>ApplicationFactory</code>).</li>
</ul>
<p>This is to ensure that the <code>NotFound</code> middleware executes <em>after</em> any routed
middleware, as you only want it to execute if no routed middleware was selected.</p>

<hr />

<nav>
  <ul class="pager">
    <li class="previous">
      <a rel="prev" href="../route-specific-pipeline/"><i class="fa fa-arrow-left"></i> Previous</a>
    </li>
    <li class="next">
      <a rel="next" href="../using-custom-view-helpers/">Next <i class="fa fa-arrow-right"></i></a>
    </li>
  </ul>
</nav></div>
        
    </div>
    <!-- content:end -->

    <footer class="col-md-12 text-center">
        <hr>
        <p>
        <small>Copyright (c) 2016 <a href="http://www.zend.com/">Zend Technologies USA Inc.</a><br></small>
        </p>
        <p><small><a href="http://framework.zend.com">Learn more about Zend Framework</a></small></p>
    </footer>

    <script src="../../js/jquery-1.10.2.min.js"></script>
    <script src="../../js/bootstrap-3.0.3.min.js"></script>
    <script src="../../js/prism-zf.js"></script>

    <script>var base_url = '../..';</script>
    <script data-main="../../mkdocs/js/search.js" src="../../mkdocs/js/require.js"></script>
    <script src="../../js/base.js"></script>

    <div class="modal" id="mkdocs_search_modal" tabindex="-1" role="dialog" aria-labelledby="Search Modal" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <button type="button" class="close" data-dismiss="modal">
                        <span aria-hidden="true">&times;</span>
                        <span class="sr-only">Close</span>
                    </button>
                    <h4 class="modal-title" id="exampleModalLabel">Search</h4>
                </div>
                <div class="modal-body">
                    <p>
                        From here you can search these documents. Enter your search terms below.
                    </p>
                    <form role="form">
                        <div class="form-group">
                            <input type="text" class="form-control" placeholder="Search..." id="mkdocs-search-query">
                        </div>
                    </form>
                    <div id="mkdocs-search-results"></div>
                </div>
                <div class="modal-footer">
                </div>
            </div>
        </div>
    </div>

    </body>

</html>
